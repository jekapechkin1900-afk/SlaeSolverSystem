<mah:MetroWindow x:Class="SlaeSolverSystem.Client.Wpf.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
        xmlns:local="clr-namespace:SlaeSolverSystem.Client.Wpf"
        mah:DialogParticipation.Register="{Binding}"
        xmlns:vm="clr-namespace:SlaeSolverSystem.Client.Wpf.ViewModels"
        xmlns:converters="clr-namespace:SlaeSolverSystem.Client.Wpf.Converters"
        mc:Ignorable="d"
        Title="Распределённая информационная система решения СЛАУ на основе метода Гаусса-Зейделя" MinHeight="600" MinWidth="900"
        WindowStartupLocation="CenterScreen"
        FontSize="16" FontFamily="Arial"
        BorderBrush="{DynamicResource MahApps.Brushes.Accent}"
        BorderThickness="0.3">
    <mah:MetroWindow.Resources>
        <converters:StringToVisibilityConverter x:Key="StringToVisibilityConverter"/>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </mah:MetroWindow.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <mah:MetroTabControl Grid.Row="0">
            <!--======================================
                 ВКЛАДКА 1: Решение СЛАУ
            =======================================-->
            <mah:MetroTabItem Header="Решение СЛАУ">
                <Grid Margin="15">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="380"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Левая колонка: Параметры -->
                    <StackPanel Grid.Column="0" Margin="0,0,15,0" IsEnabled="{Binding IsNotRunning}">
                        <GroupBox Header="Параметры запуска" Style="{StaticResource MahApps.Styles.GroupBox}" Margin="0,0,0,15">
                            <StackPanel>
                                <TextBlock Text="Файл матрицы A:" Margin="0,5,0,2"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBox x:Name="MatrixTextBox"
                                         Text="{Binding MatrixFilePath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                         AllowDrop="True"
                                         PreviewDragOver="TextBox_PreviewDragOver"
                                         DragEnter="TextBox_DragEnter"
                                         DragLeave="TextBox_DragLeave"
                                         Drop="MatrixTextBox_Drop"/>
                                    <Button Grid.Column="1" Content="..." Command="{Binding BrowseMatrixCommand}" Margin="5,0,0,0"/>
                                </Grid>

                                <TextBlock Text="Файл вектора B:" Margin="0,10,0,2"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBox x:Name="VectorTextBox"
                                         Text="{Binding VectorFilePath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                         AllowDrop="True"
                                         PreviewDragOver="TextBox_PreviewDragOver"
                                         DragEnter="TextBox_DragEnter"
                                         DragLeave="TextBox_DragLeave"
                                         Drop="VectorTextBox_Drop"/>
                                    <Button Grid.Column="1" Content="..." Command="{Binding BrowseVectorCommand}" Margin="5,0,0,0"/>
                                </Grid>

                                <TextBlock Text="Файл со списком узлов:" Margin="0,10,0,2"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBox x:Name="NodesTextBox"
                                         Text="{Binding NodesFilePath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                         AllowDrop="True"
                                         PreviewDragOver="TextBox_PreviewDragOver"
                                         DragEnter="TextBox_DragEnter"
                                         DragLeave="TextBox_DragLeave"
                                         Drop="NodesTextBox_Drop"/>
                                    <Button Grid.Column="1" Content="..." Command="{Binding BrowseNodesCommand}" Margin="5,0,0,0"/>
                                </Grid>
                            </StackPanel>
                        </GroupBox>

                        <GroupBox Header="Настройки метода" Style="{StaticResource MahApps.Styles.GroupBox}">
                            <StackPanel>
                                <TextBlock Text="Точность (Epsilon):" Margin="0,5,0,2"/>
                                <mah:NumericUpDown Value="{Binding Epsilon, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                   StringFormat="G9" Interval="0.00001" Minimum="0.000000000001"/>

                                <TextBlock Text="Макс. итераций:" Margin="0,10,0,2"/>
                                <mah:NumericUpDown Value="{Binding MaxIterations, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                   Interval="100" Minimum="1"/>
                            </StackPanel>
                        </GroupBox>
                            
                        <Button FontSize="18" Content="ЗАПУСК (Распределенный)" Command="{Binding StartDistributedTestCommand}" Margin="0,20,0,0" Height="40" IsEnabled="{Binding IsNotRunning}" mah:ControlsHelper.ContentCharacterCasing="Upper" Background="#FF0767B3"/>
                    </StackPanel>

                    <!-- Правая колонка: Мониторинг и Результат -->
                    <StackPanel Grid.Column="1">
                        <GroupBox Header="Состояние Worker'ов" Style="{StaticResource MahApps.Styles.GroupBox}" Margin="0,0,0,15">
                            <TextBlock FontSize="14" HorizontalAlignment="Center">
                                <Run Text="Доступно: "/>
                                <Run Text="{Binding AvailableWorkers, Mode=OneWay}" FontWeight="Bold" Foreground="{DynamicResource MahApps.Brushes.Accent}"/>
                                <Run Text=" из "/>
                                <Run Text="{Binding TotalWorkers, Mode=OneWay}" FontWeight="Bold"/>
                            </TextBlock>
                        </GroupBox>
                        
                        <GroupBox Header="Мониторинг" Style="{StaticResource MahApps.Styles.GroupBox}">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Статус:" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding StatusText}" TextWrapping="Wrap" VerticalAlignment="Center"/>

                                <TextBlock Grid.Row="1" Grid.Column="0" Text="Итерация:" FontWeight="SemiBold" Margin="0,10,0,0" VerticalAlignment="Center"/>
                                <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding Iteration}" Margin="0,10,0,0" VerticalAlignment="Center"/>

                                <TextBlock Grid.Row="2" Grid.Column="0" Text="Погрешность:" FontWeight="SemiBold" Margin="0,10,0,0" VerticalAlignment="Center"/>
                                <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding CurrentError, StringFormat={}{0:E5}}" Margin="0,10,0,0" VerticalAlignment="Center"/>
                            </Grid>
                        </GroupBox>

                        <GroupBox Header="Результат вычислений" Style="{StaticResource MahApps.Styles.GroupBox}" Margin="0,15,0,0"
                                  Visibility="{Binding ResultPreviewText, Converter={StaticResource StringToVisibilityConverter}}">
                            <StackPanel>
                                <TextBlock Text="{Binding ResultPreviewText}" FontFamily="Consolas" Margin="0,5,0,0"/>
                                <TextBlock Text="{Binding ResultFilePathOnServer}" FontStyle="Italic" Margin="0,10,0,0" TextWrapping="Wrap"/>
                                <Button FontSize="12" Content="Сохранить как..." Command="{Binding SaveResultCommand}" IsEnabled="{Binding CanSaveResult}" Margin="0,10,0,0" HorizontalAlignment="Left" Background="#FF0D67AE" Width="164"/>
                            </StackPanel>
                        </GroupBox>
                    </StackPanel>
                </Grid>
            </mah:MetroTabItem>

            <!--======================================
                 ВКЛАДКА 2: Сравнение
            =======================================-->
            <mah:MetroTabItem Header="Сравнение производительности">
                <Grid Margin="15">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <WrapPanel Grid.Row="0" Margin="0,0,0,15">
                        <Button Content="Гаусс (линейный)" Command="{Binding StartGaussLinearCommand}" IsEnabled="{Binding IsNotRunning}" Margin="5"/>
                        <Button Content="Г-З (1-поток)" Command="{Binding StartSeidelLinearCommand}" IsEnabled="{Binding IsNotRunning}" Margin="5"/>
                        <Button Content="Г-З (ThreadPool)" Command="{Binding StartSeidelMultiThreadPoolCommand}" IsEnabled="{Binding IsNotRunning}" Margin="5"/>
                        <Button Content="Г-З (Threads)" Command="{Binding StartSeidelMultiThreadNoPoolCommand}" IsEnabled="{Binding IsNotRunning}" Margin="5"/>
                        <Button Content="Г-З (Async)" Command="{Binding StartSeidelMultiThreadAsyncCommand}" IsEnabled="{Binding IsNotRunning}" Margin="5"/>
                        <Button Content="Распределенный" Command="{Binding StartDistributedTestCommand}" IsEnabled="{Binding IsNotRunning}" Margin="5" />
                        <Button Content="Очистить" Command="{Binding ClearResultsCommand}" IsEnabled="{Binding IsNotRunning}" Margin="5"/>
                    </WrapPanel>

                    <DataGrid Grid.Row="1" ItemsSource="{Binding TestResults}" AutoGenerateColumns="False" IsReadOnly="True" CanUserAddRows="False" FontSize="14" Style="{StaticResource MahApps.Styles.DataGrid.Azure}">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Тип теста" Binding="{Binding TestType}" Width="*"/>
                            <DataGridTextColumn Header="Размер матрицы" Binding="{Binding MatrixSize}" Width="150"/>
                            <DataGridTextColumn Header="Итераций" Binding="{Binding Iterations}" Width="100"/>
                            <DataGridTextColumn Header="Время (мс)" Binding="{Binding TimeMs}" Width="120" SortDirection="Ascending"/>
                            <DataGridTextColumn Header="Ускорение (Speedup)" Binding="{Binding Speedup, StringFormat={}{0:F2}x}" Width="150"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </mah:MetroTabItem>

            <!--======================================
                 ВКЛАДКА 3: Логи
            =======================================-->
            <mah:MetroTabItem Header="Логи выполнения">
                <Grid Margin="15">
                    <TextBox Text="{Binding LogText, Mode=OneWay}" 
                         IsReadOnly="True" 
                         AcceptsReturn="True"
                         FontFamily="Consolas" 
                         FontSize="12"
                         VerticalScrollBarVisibility="Auto" 
                         HorizontalScrollBarVisibility="Auto"
                         TextWrapping="NoWrap" />   
                </Grid>
            </mah:MetroTabItem>
        </mah:MetroTabControl>

        <!-- Панель состояния -->
        <StatusBar Grid.Row="1">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusText}"/>
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal" Visibility="{Binding IsRunning, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="{Binding ElapsedTime, StringFormat='hh\\:mm\\:ss'}" Margin="0,0,10,0" VerticalAlignment="Center"/>
                    <mah:ProgressRing IsActive="{Binding IsRunning}" Width="18" Height="18" />
                </StackPanel>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</mah:MetroWindow>
